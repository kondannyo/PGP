### Latex.Make
# Author: Jason Hiebel
# This version of this file was taken from the repo found at 
# http://github.com/jrsmith3/latex_template

# This is a simple makefile for compiling LaTeX documents.

# Targets:
#    default : compiles the document in to three formats (DVI -> PS -> PDF)
#    display : displays the compiled document in a common PDF viewer.
#              (Linux = Evince, OSX = OS Set Default)
#    clean   : removes the build/ directory holding temporary files


# Set PROJECT to the name of the .tex file to build.
PROJECT =majjhima_nikaya_master
SOURCE_DIR = sc_po_text/
BIN_DIR = ../bin/
BUILD_DIR = build/
TXMKR_BUILD_DIR = tex_build/

default: $(BUILD_DIR)/$(PROJECT).pdf

display: default
	(${PDFVIEWER} $(PROJECT).pdf &)

print-%  : ; @echo $* = $($*)

wc: default
	@ echo "Word count:"
	@ pdftotext /$(PROJECT).pdf - | wc -w
	@ echo "\r"

### Compilation Flags
LATEX_FLAGS  = -halt-on-error -jobname=$(BUILD_DIR)/$(PROJECT)

BUILD_SOURCE_FILES = $(wildcard $(SOURCE_DIR)/*_sc_pali)
BUILD_TEX_TARGETS = $(patsubst $(SOURCE_DIR)/%_sc_pali, $(TXMKR_BUILD_DIR)/%.tex, $(wildcard $(SOURCE_DIR)/*_sc_pali))

### File Types (for dependancies)
TEX_FILES = \
	../share/PM_A5_Definition.tex \
	../share/PM_Font_TGT.tex \
	../share/PM_BWDefintions.tex \
	../share/PM_Tri_Gloss.tex \
	../share/PM_UnicodeCharacterFix.tex \
	$(BUILD_TEX_TARGETS) \
	$(TXMKR_BUILD_DIR)/mn001.tex \
	$(TXMKR_BUILD_DIR)/mn002.tex \
	$(TXMKR_BUILD_DIR)/mn003.tex \
	$(TXMKR_BUILD_DIR)/mn004.tex \
	$(TXMKR_BUILD_DIR)/mn005.tex 
BIN_FILES = \
	$(BIN_DIR)/txmkr \
	$(BIN_DIR)/txmakerwrapper.py \
	$(BIN_DIR)/glosstext.py

STY_FILES = $(shell find . -name '*.sty')
	#share/PM_AnsiADefinition.tex 
	#share/PM_AnsiBDefinition.tex 
	#share/PM_Font_TGP.tex} # TexGyrePagella 
	#share/PM_ColorDefintions.tex 
	#BIB_FILES = $(shell find . -name '*.bib')
	#CLS_FILES = $(shell find . -name '*.cls')
	#BST_FILES = $(shell find . -name '*.bst')
	#EPS_FILES = $(shell find . -name '*.eps')


### Standard PDF Viewers

UNAME := $(shell uname)

ifeq ($(UNAME), Linux)
PDFVIEWER = evince
endif
ifeq ($(UNAME), Darwin)
PDFVIEWER = open
endif


### Clean
# This target cleans the temporary files generated by the tex programs in
# use. All temporary files generated by this makefile will be placed in build/
# so cleanup is easy.

clean::
	rm -rf $(BUILD_DIR)
cleantex::
	rm -rf $(TXMKR_BUILD_DIR)

### Core Latex Generation
# Performs the typical build process for latex generations so that all
# references are resolved correctly. If adding components to this run-time
# always take caution and implement the worst case set of commands.
# Example: latex, bibtex, latex, latex
#
# Note the use of order-only prerequisites (prerequisites following the |).
# Order-only prerequisites do not affect the target -- if the order-only
# prerequisite has changed and none of the normal prerequisites have changed
# then this target IS NOT run.

$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

$(TXMKR_BUILD_DIR):
	mkdir -p $(TXMKR_BUILD_DIR)

$(TXMKR_BUILD_DIR)/%.tex: $(SOURCE_DIR)/%_sc_pali $(SOURCE_DIR)/%_sc_engl $(BIN_FILES) $(TXMKR_BUILD_DIR) 
	$(BIN_DIR)/txmkr -n --output=$@ $< $(word 2,$^)

#build/$(PROJECT).aux: $(TEX_FILES) $(STY_FILES) | build/
#	xelatex $(LATEX_FLAGS) $(PROJECT).tex

#build/$(PROJECT).bbl: $(BIB_FILES) $(BST_FILES) | build/$(PROJECT).aux
#ifneq ($(BIB_FILES),)
#	cp *.bib build
#	( cd build && bibtex $(PROJECT) )
#	xelatex $(LATEX_FLAGS) $(PROJECT)
#endif
	
$(BUILD_DIR)/$(PROJECT).pdf: $(TEX_FILES) $(BIN_FILES) | $(BUILD_DIR)
	xelatex $(LATEX_FLAGS) $(PROJECT).tex

